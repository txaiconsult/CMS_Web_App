<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda de Rappel - Firebase</title>
    <style>
        body {font-family:Arial,sans-serif;margin:0;padding:20px;background-color:#f5f5f5;}
        .container {max-width:1200px;margin:0 auto;background-color:white;padding:20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);}
        h1,h2,h3 {color:#2c3e50;margin-top:0;}
        .header {display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
        .navigation {display:flex;gap:10px;}
        .nav-button {padding:8px 15px;background-color:#3498db;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold;}
        .nav-button:hover {background-color:#2980b9;}
        .current-date {font-size:1.5rem;font-weight:bold;margin:10px 0;}
        .view-toggle {display:flex;gap:10px;margin-bottom:20px;}
        .view-button {padding:8px 15px;background-color:#f2f2f2;border:none;border-radius:4px;cursor:pointer;}
        .view-button.active {background-color:#3498db;color:white;}
        
        /* Style pour les boutons de navigation entre pages */
        .page-navigation {display:flex;gap:15px;margin-bottom:20px;}
        .page-nav-button {padding:10px 20px;background-color:#f8f9fa;color:#2c3e50;text-decoration:none;border-radius:4px;font-weight:bold;border:1px solid #e2e8f0;transition:all 0.3s ease;}
        .page-nav-button:hover {background-color:#e2e8f0;}
        .page-nav-button.active {background-color:#3498db;color:white;border-color:#3498db;}
        
        .calendar {margin-bottom:30px;}
        .calendar-header {display:grid;grid-template-columns:repeat(7,1fr);background-color:#f2f2f2;padding:10px 0;border-radius:4px 4px 0 0;font-weight:bold;text-align:center;}
        .calendar-grid {display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background-color:#ddd;}
        .calendar-day {background-color:white;min-height:100px;padding:5px;position:relative;}
        .calendar-day-header {text-align:right;padding:5px;font-weight:bold;}
        .calendar-day.today {background-color:#f0f9ff;}
        .calendar-day.other-month {background-color:#f9f9f9;color:#aaa;}
        .event {margin:5px 0;padding:5px;border-radius:4px;font-size:0.8rem;background-color:#fff3cd;border-left:3px solid #fd7e14;cursor:pointer;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        .event:hover {background-color:#ffecb5;}
        .day-view,.week-view,.month-view,.list-view {display:none;}
        .list-view {display:block;}
        .list-group {margin-bottom:20px;border:1px solid #e2e8f0;border-radius:8px;overflow:hidden;}
        .list-header {background-color:#f8f9fa;padding:10px 15px;border-bottom:1px solid #e2e8f0;font-weight:bold;}
        .list-item {padding:10px 15px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;transition:background-color 0.2s;}
        .list-item:last-child {border-bottom:none;}
        .list-item:hover {background-color:#f0f9ff;}
        .list-item-time {font-weight:bold;width:80px;}
        .list-item-content {flex:1;margin:0 15px;}
        .list-item-actions button {padding:5px 10px;border:none;border-radius:4px;cursor:pointer;margin-left:5px;}
        .btn-complete {background-color:#2ecc71;color:white;}
        .btn-complete:hover {background-color:#27ae60;}
        .btn-details {background-color:#3498db;color:white;}
        .btn-details:hover {background-color:#2980b9;}
        .btn-reschedule {background-color:#f39c12;color:white;}
        .btn-reschedule:hover {background-color:#e67e22;}
        .tag {display:inline-block;padding:3px 8px;border-radius:4px;font-size:12px;color:white;margin-right:5px;}
        .tag-received {background-color:#3498db;}
        .tag-outgoing {background-color:#2ecc71;}
        .tag-other {background-color:#9b59b6;}
        .modal {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);z-index:1001;justify-content:center;align-items:center;}
        .modal-content {background-color:white;padding:20px;width:50%;max-width:500px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.3);position:relative;max-height:80vh;overflow-y:auto;}
        .close {position:absolute;top:10px;right:20px;font-size:24px;font-weight:bold;cursor:pointer;}
        .form-group {margin-bottom:15px;}
        label {display:block;margin-bottom:5px;font-weight:bold;}
        input,select,textarea {width:100%;padding:8px;box-sizing:border-box;border:1px solid #ddd;border-radius:4px;}
        .btn-group {display:flex;gap:10px;}
        .btn {padding:10px 15px;border:none;border-radius:4px;cursor:pointer;font-weight:bold;}
        .btn-primary {background-color:#3498db;color:white;}
        .btn-primary:hover {background-color:#2980b9;}
        .notification {position:fixed;bottom:20px;left:20px;padding:10px 20px;border-radius:4px;color:white;font-weight:bold;z-index:9999;display:none;}
        .notification.success {background-color:#2ecc71;}
        .notification.error {background-color:#e74c3c;}
        .notification.info {background-color:#3498db;}
        .counter-bubble {display:inline-block;background-color:#e74c3c;color:white;border-radius:50%;width:24px;height:24px;text-align:center;line-height:24px;font-size:14px;margin-left:5px;}
        .loading {text-align:center;padding:20px;font-style:italic;color:#7f8c8d;}
        .time-grid {display:grid;grid-template-columns:60px 1fr;gap:1px;background-color:#ddd;}
        .time-slot {background-color:white;height:60px;padding:5px;border-bottom:1px solid #f0f0f0;}
        .time-label {text-align:right;padding-right:10px;color:#666;font-size:12px;}
        .time-content {position:relative;}
        .time-event {position:absolute;left:0;right:0;padding:5px;border-radius:4px;font-size:0.8rem;background-color:#fff3cd;border-left:3px solid #fd7e14;overflow:hidden;cursor:pointer;}
        .search-container {margin-bottom:20px;}
        .search-container input {width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;}
        .stats-container {display:flex;gap:20px;margin-bottom:20px;}
        .stat-card {background-color:white;padding:15px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.1);flex:1;text-align:center;}
        .stat-value {font-size:1.8rem;font-weight:bold;margin:10px 0;}
        .stat-label {color:#7f8c8d;font-size:0.9rem;}
        .stat-today {color:#3498db;}
        .stat-tomorrow {color:#2ecc71;}
        .stat-week {color:#f39c12;}
        .stat-overdue {color:#e74c3c;}
        /* Ajouter les styles pour le mini-calendrier */
        .mini-calendar {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            background-color: white;
        }
        .mini-calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .mini-calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .mini-calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        .mini-calendar-day {
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 4px;
        }
        .mini-calendar-day:hover {
            background-color: #f0f0f0;
        }
        .mini-calendar-day.other-month {
            color: #ccc;
        }
        .mini-calendar-day.selected {
            background-color: #3498db;
            color: white;
        }
        .mini-calendar-day.today {
            border: 1px solid #3498db;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Agenda de Rappel</h1>
            <div class="navigation">
                <button id="todayBtn" class="nav-button">Aujourd'hui</button>
                <button id="prevBtn" class="nav-button">&#8592;</button>
                <button id="nextBtn" class="nav-button">&#8594;</button>
            </div>
        </div>
        
        <!-- Nouvelle section de navigation entre pages -->
        <div class="page-navigation">
            <a href="index.html" class="page-nav-button">Accueil</a>
            <a href="calls.html" class="page-nav-button">Journal des Appels</a>
            <a href="agenda.html" class="page-nav-button active">Agenda de Rappel</a>
        </div>
        
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-value stat-today" id="todayCounter">0</div>
                <div class="stat-label">Aujourd'hui</div>
            </div>
            <div class="stat-card">
                <div class="stat-value stat-tomorrow" id="tomorrowCounter">0</div>
                <div class="stat-label">Demain</div>
            </div>
            <div class="stat-card">
                <div class="stat-value stat-week" id="weekCounter">0</div>
                <div class="stat-label">Cette semaine</div>
            </div>
            <div class="stat-card">
                <div class="stat-value stat-overdue" id="overdueCounter">0</div>
                <div class="stat-label">En retard</div>
            </div>
        </div>
        
        <div class="current-date" id="currentDateDisplay">Mars 2025</div>
        
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Rechercher par nom, numéro ou commentaire...">
        </div>
        
        <div class="view-toggle">
            <button class="view-button" id="monthViewBtn">Mois</button>
            <button class="view-button active" id="listViewBtn">Liste</button>
        </div>
        
        <div id="monthView" class="month-view">
            <div class="calendar">
                <div class="calendar-header">
                    <div>Dim</div>
                    <div>Lun</div>
                    <div>Mar</div>
                    <div>Mer</div>
                    <div>Jeu</div>
                    <div>Ven</div>
                    <div>Sam</div>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Jours générés dynamiquement -->
                </div>
            </div>
        </div>
        
        <div id="listView" class="list-view">
            <div id="listContainer">
                <div class="loading" id="loadingIndicator">Chargement des rappels...</div>
                <!-- Contenu généré dynamiquement -->
            </div>
        </div>
    </div>
    
    <!-- Modal pour les détails du rappel -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <span class="close" onclick="fermerModal('detailModal')">&times;</span>
            <h2>Détails du rappel</h2>
            <div id="detailContent">
                <!-- Contenu généré dynamiquement -->
            </div>
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-primary" id="markCompleteBtn">Marquer comme terminé</button>
                <button class="btn btn-primary" id="rescheduleBtn" style="background-color: #f39c12;">Reprogrammer</button>
            </div>
        </div>
    </div>
    
    <!-- Modal pour reprogrammer un rappel -->
    <div class="modal" id="rescheduleModal">
        <div class="modal-content">
            <span class="close" onclick="fermerModal('rescheduleModal')">&times;</span>
            <h2>Reprogrammer le rappel</h2>
            <div class="form-group">
                <label for="newDateTime">Nouvelle date et heure :</label>
                <input type="datetime-local" id="newDateTime">
            </div>
            
            <!-- Nouveau calendrier pour la sélection visuelle de date -->
            <div class="form-group">
                <label>Sélectionner une date :</label>
                <div class="mini-calendar">
                    <div class="mini-calendar-header">
                        <button class="btn" id="prevMonthBtn">&lt;</button>
                        <div id="miniCalendarTitle">Janvier 2023</div>
                        <button class="btn" id="nextMonthBtn">&gt;</button>
                    </div>
                    <div class="mini-calendar-weekdays">
                        <div>D</div><div>L</div><div>M</div><div>M</div><div>J</div><div>V</div><div>S</div>
                    </div>
                    <div class="mini-calendar-days" id="miniCalendarDays">
                        <!-- Les jours seront générés dynamiquement -->
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button class="btn" onclick="ajusterDate(-1)">-1 jour</button>
                    <button class="btn" onclick="ajusterDate(1)">+1 jour</button>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="ajusterDate(0, 'today')">Aujourd'hui</button>
                    <button class="btn" onclick="ajusterDate(0, 'tomorrow')">Demain</button>
                    <button class="btn" onclick="ajusterDate(0, 'nextWorkDay')">Prochain jour ouvré</button>
                </div>
            </div>
            <button class="btn btn-primary" id="saveRescheduleBtn">Enregistrer</button>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getFirestore, collection, doc, updateDoc, getDoc, getDocs, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDqLgCObybog6fGl9FWe2i9uGu10C-pfIg",
            authDomain: "ouioui-9cc8f.firebaseapp.com",
            projectId: "ouioui-9cc8f",
            storageBucket: "ouioui-9cc8f.appspot.com",
            messagingSenderId: "661460129930",
            appId: "1:661460129930:web:b46c5c2529c5585f557573"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Variables globales
        let rappels = []; // Tableau pour stocker les rappels
        let currentDate = new Date(); // Date actuelle pour la navigation
        let currentView = 'list'; // Vue actuelle (month, list)
        let selectedRappelId = null; // ID du rappel sélectionné pour les détails ou la reprogrammation
        let miniCalendarDate = new Date(); // Date pour le mini-calendrier

        // ----- Fonctions de manipulation de date -----
        function formatDate(date) {
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
        }
        
        function formatShortDate(date) {
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        }
        
        function formatTime(date) {
            return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }
        
        function isSameDay(date1, date2) {
            return date1.getDate() === date2.getDate() && date1.getMonth() === date2.getMonth() && date1.getFullYear() === date2.getFullYear();
        }
        
        function isToday(date) {
            const today = new Date();
            return isSameDay(date, today);
        }
        
        function isTomorrow(date) {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            return isSameDay(date, tomorrow);
        }
        
        function isThisWeek(date) {
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            // Fix for isThisWeek function - ensure dates are comparable
            const checkDate = new Date(date);
            checkDate.setHours(0, 0, 0, 0);
            startOfWeek.setHours(0, 0, 0, 0);
            endOfWeek.setHours(23, 59, 59, 999);
            
            return checkDate >= startOfWeek && checkDate <= endOfWeek;
        }
        
        function isOverdue(date) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Ensure date comparison works correctly
            const compareDate = new Date(date);
            compareDate.setHours(0, 0, 0, 0);
            
            return compareDate < today;
        }
        
        function getFirstDayOfMonth(year, month) {
            return new Date(year, month, 1);
        }
        
        function getLastDayOfMonth(year, month) {
            return new Date(year, month + 1, 0);
        }
        
        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }
        
        function getDayOfWeek(date) {
            return date.getDay();
        }
        
        function getNextWorkDay() {
            const result = new Date();
            result.setDate(result.getDate() + 1);
            const dayOfWeek = result.getDay();
            if (dayOfWeek === 0) result.setDate(result.getDate() + 1);
            else if (dayOfWeek === 6) result.setDate(result.getDate() + 2);
            return result;
        }

        // ----- Fonctions de chargement des données -----
        function chargerRappels() {
            // Écouter les changements dans la collection "appels" avec enAttente=true
            onSnapshot(query(collection(db, "appels"), where("enAttente", "==", true)), (snapshot) => {
                const rappelsAppels = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    let dateRelance = null;
                    if (data.dateRelance) {
                        dateRelance = new Date(data.dateRelance);
                    }
                    rappelsAppels.push({
                        id: doc.id,
                        ...data,
                        dateRelanceObj: dateRelance,
                        source: "appels"
                    });
                });
                
                // Maintenant, écouter aussi la collection "agenda" mais exclure les éléments terminés
                onSnapshot(collection(db, "agenda"), (snapshot) => {
                    const rappelsAgenda = [];
                    console.log(`Chargement de ${snapshot.size} éléments de l'agenda`);
                    
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        console.log("Document agenda:", doc.id, data);
                        
                        // Ne pas inclure les éléments marqués comme terminés
                        if ((data.termine === true) || (data.statut === "termine")) {
                            console.log(`Élément agenda ignoré (terminé): ${doc.id}, titre: ${data.titre}`);
                            return;
                        }
                        
                        let dateDebut = null;
                        try {
                            if (data.dateDebut) {
                                dateDebut = new Date(data.dateDebut);
                                console.log(`Agenda item: ${data.titre}, dateDebut: ${data.dateDebut}, parsed as: ${dateDebut.toLocaleString()}`);
                            } else {
                                console.warn(`Agenda item sans dateDebut: ${data.titre}`);
                            }
                        } catch (error) {
                            console.error(`Erreur lors du parsing de la date pour ${data.titre}:`, error);
                        }
                        
                        // Créer un objet rappel avec les données de l'agenda
                        const rappelAgenda = {
                            id: doc.id,
                            nom: data.contact?.nom || data.titre || "Sans titre",
                            telephone: data.contact?.telephone || "",
                            commentaire: data.description || "",
                            dateRelanceObj: dateDebut,
                            type: data.type || "autre",
                            autreType: data.autreType || (data.source === "journal_appels" ? "Rappel" : ""),
                            statut: data.statut || "planifie",
                            source: "agenda",
                            appelId: data.appelId || null,
                            titre: data.titre || ""
                        };
                        
                        console.log("Ajout d'un élément agenda:", rappelAgenda);
                        rappelsAgenda.push(rappelAgenda);
                    });
                    
                    // Combiner les deux sources de rappels
                    rappels = [...rappelsAppels, ...rappelsAgenda];
                    console.log(`Loaded ${rappelsAppels.length} call items and ${rappelsAgenda.length} agenda items`);
                    
                    // Trier par date
                    rappels.sort((a, b) => {
                        if (!a.dateRelanceObj) return 1;
                        if (!b.dateRelanceObj) return -1;
                        return a.dateRelanceObj - b.dateRelanceObj;
                    });
                    
                    document.getElementById('loadingIndicator').style.display = 'none';
                    miseAJourAffichage();
                    // Pas besoin d'appeler miseAJourCompteurs() ici car miseAJourAffichage() le fait déjà
                });
            });
        }

        function miseAJourCompteurs() {
            console.log("Mise à jour des compteurs...");
            
            // Utiliser Date.now() pour obtenir l'horodatage actuel
            const now = new Date();
            
            // Créer des dates avec des heures exactes pour améliorer la précision des comparaisons
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
            const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0, 0);
            const endOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
            
            let countToday = 0, countTomorrow = 0, countWeek = 0, countOverdue = 0;
            
            // Pour le début et la fin de la semaine (lundi au dimanche)
            const startOfWeek = new Date(today);
            const dayOfWeek = today.getDay(); // 0 = dimanche, 1 = lundi, etc.
            startOfWeek.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1)); // Ajuster au lundi
            startOfWeek.setHours(0, 0, 0, 0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6); // Dimanche
            endOfWeek.setHours(23, 59, 59, 999);
            
            // Debug info
            console.log(`Today: ${today.toISOString()}, End of Today: ${endOfToday.toISOString()}`);
            console.log(`Tomorrow: ${tomorrow.toISOString()}`);
            console.log(`Week range: ${startOfWeek.toISOString()} to ${endOfWeek.toISOString()}`);
            console.log(`Total rappels: ${rappels.length}`);
            
            rappels.forEach(rappel => {
                if (!rappel.dateRelanceObj) {
                    console.log(`Rappel sans date: ${rappel.nom || 'sans nom'}, ID: ${rappel.id}`);
                    return;
                }
                
                try {
                    // Cloner la date pour éviter toute modification accidentelle
                    const rappelDate = new Date(rappel.dateRelanceObj.getTime());
                    
                    // Créer une date pour la comparaison "aujourd'hui" (sans heure)
                    const rappelDateStart = new Date(
                        rappelDate.getFullYear(),
                        rappelDate.getMonth(),
                        rappelDate.getDate(),
                        0, 0, 0, 0
                    );
                    
                    const rappelDateEnd = new Date(
                        rappelDate.getFullYear(),
                        rappelDate.getMonth(),
                        rappelDate.getDate(),
                        23, 59, 59, 999
                    );
                    
                    // Debug logs plus détaillés
                    console.log(`Vérification rappel: ${rappel.nom}, date: ${rappelDate.toISOString()}`);
                    console.log(`  isToday: ${rappelDateStart <= endOfToday && rappelDateEnd >= today}`);
                    console.log(`  isTomorrow: ${rappelDateStart.getTime() === tomorrow.getTime()}`);
                    console.log(`  isThisWeek: ${rappelDateStart >= startOfWeek && rappelDateEnd <= endOfWeek}`);
                    console.log(`  isOverdue: ${rappelDateEnd < today}`);
                    
                    // Aujourd'hui (entre le début et la fin du jour)
                    if (rappelDateStart <= endOfToday && rappelDateEnd >= today) {
                        countToday++;
                        console.log(`  ✓ Compteur aujourd'hui incrémenté`);
                    }
                    
                    // Demain
                    if (rappelDateStart.getFullYear() === tomorrow.getFullYear() &&
                        rappelDateStart.getMonth() === tomorrow.getMonth() &&
                        rappelDateStart.getDate() === tomorrow.getDate()) {
                        countTomorrow++;
                        console.log(`  ✓ Compteur demain incrémenté`);
                    }
                    
                    // Cette semaine (du lundi au dimanche)
                    if (rappelDateStart >= startOfWeek && rappelDateEnd <= endOfWeek) {
                        countWeek++;
                        console.log(`  ✓ Compteur semaine incrémenté`);
                    }
                    
                    // En retard
                    if (rappelDateEnd < today) {
                        countOverdue++;
                        console.log(`  ✓ Compteur retard incrémenté`);
                    }
                    
                } catch (error) {
                    console.error("Error processing date in counter:", error, rappel);
                }
            });
            
            // Mise à jour des compteurs dans l'interface
            document.getElementById('todayCounter').textContent = countToday;
            document.getElementById('tomorrowCounter').textContent = countTomorrow;
            document.getElementById('weekCounter').textContent = countWeek;
            document.getElementById('overdueCounter').textContent = countOverdue;
            
            console.log(`Compteurs mis à jour: Aujourd'hui=${countToday}, Demain=${countTomorrow}, Semaine=${countWeek}, En retard=${countOverdue}`);
        }

        // ----- Fonctions de l'interface utilisateur -----
        function miseAJourAffichage() {
            document.getElementById('currentDateDisplay').textContent = formatDate(currentDate);
            
            switch (currentView) {
                case 'month': afficherVueMois(); break;
                case 'list': 
                default: afficherVueListe(); break;
            }
            
            // Toujours mettre à jour les compteurs après une mise à jour de l'affichage
            miseAJourCompteurs();
        }
        
        function afficherVueMois() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentDateDisplay').textContent = 
                currentDate.toLocaleString('fr-FR', { month: 'long', year: 'numeric' });
            
            const firstDay = getFirstDayOfMonth(year, month);
            const firstDayOfWeek = getDayOfWeek(firstDay);
            const daysInMonth = getDaysInMonth(year, month);
            const daysInPrevMonth = getDaysInMonth(year, month - 1);
            
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            for (let i = 0; i < firstDayOfWeek; i++) {
                const prevMonthDay = daysInPrevMonth - firstDayOfWeek + i + 1;
                
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day other-month';
                
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = prevMonthDay;
                
                dayCell.appendChild(dayHeader);
                calendarGrid.appendChild(dayCell);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                
                if (isToday(date)) {
                    dayCell.classList.add('today');
                }
                
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                
                dayCell.appendChild(dayHeader);
                
                const startOfDay = new Date(date);
                startOfDay.setHours(0, 0, 0, 0);
                const endOfDay = new Date(date);
                endOfDay.setHours(23, 59, 59, 999);
                
                const rappelsDuJour = rappels.filter(rappel => {
                    if (!rappel.dateRelanceObj) return false;
                    return rappel.dateRelanceObj >= startOfDay && rappel.dateRelanceObj <= endOfDay;
                });
                
                if (rappelsDuJour.length > 0) {
                    console.log(`Month view day ${day}: ${rappelsDuJour.length} items`);
                }

                rappelsDuJour.forEach(rappel => {
                    const event = document.createElement('div');
                    event.className = 'event';
                    
                    const heureStr = rappel.dateRelanceObj ? 
                        formatTime(rappel.dateRelanceObj) : '';
                    
                    event.textContent = `${heureStr} - ${rappel.nom}`;
                    
                    event.addEventListener('click', () => {
                        afficherDetailsRappel(rappel.id);
                    });
                    
                    dayCell.appendChild(event);
                });
                
                calendarGrid.appendChild(dayCell);
            }
            
            const cellsAdded = firstDayOfWeek + daysInMonth;
            const remainingCells = 42 - cellsAdded;
            
            for (let day = 1; day <= remainingCells; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day other-month';
                
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                
                dayCell.appendChild(dayHeader);
                calendarGrid.appendChild(dayCell);
            }
        }
        
        function afficherVueListe() {
            const container = document.getElementById('listContainer');
            container.innerHTML = '';
            
            if (rappels.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'loading';
                emptyMessage.textContent = 'Aucun rappel en attente';
                container.appendChild(emptyMessage);
                return;
            }
            
            const rappelsGroupes = {};
            
            rappels.forEach(rappel => {
                if (!rappel.dateRelanceObj) return;
                
                const dateKey = rappel.dateRelanceObj.toLocaleDateString('fr-FR');
                
                if (!rappelsGroupes[dateKey]) {
                    rappelsGroupes[dateKey] = [];
                }
                
                rappelsGroupes[dateKey].push(rappel);
            });
            
            const rappelsSansDate = rappels.filter(rappel => !rappel.dateRelanceObj);
            if (rappelsSansDate.length > 0) {
                rappelsGroupes['Sans date'] = rappelsSansDate;
            }
            
            console.log(`List view: ${Object.keys(rappelsGroupes).length} day groups with ${rappels.length} total items`);

            const dateKeys = Object.keys(rappelsGroupes).sort((a, b) => {
                if (a === 'Sans date') return 1;
                if (b === 'Sans date') return -1;
                
                const dateA = new Date(a.split('/').reverse().join('-'));
                const dateB = new Date(b.split('/').reverse().join('-'));
                
                return dateA - dateB;
            });
            
            dateKeys.forEach(dateKey => {
                const group = document.createElement('div');
                group.className = 'list-group';
                
                let dateLabel = dateKey;
                let styleClass = '';
                
                if (dateKey !== 'Sans date') {
                    const dateParts = dateKey.split('/');
                    const checkDate = new Date(
                        parseInt(dateParts[2]), // année
                        parseInt(dateParts[1]) - 1, // mois (0-11)
                        parseInt(dateParts[0]) // jour
                    );
                    
                    if (isToday(checkDate)) {
                        dateLabel = "Aujourd'hui";
                        styleClass = 'stat-today';
                    } else if (isTomorrow(checkDate)) {
                        dateLabel = "Demain";
                        styleClass = 'stat-tomorrow';
                    } else if (isOverdue(checkDate)) {
                        styleClass = 'stat-overdue';
                    }
                }
                
                const header = document.createElement('div');
                header.className = 'list-header';
                header.innerHTML = `<span class="${styleClass}">${dateLabel}</span> (${rappelsGroupes[dateKey].length})`;
                
                group.appendChild(header);
                
                rappelsGroupes[dateKey].forEach(rappel => {
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    
                    const heureStr = rappel.dateRelanceObj ? 
                        formatTime(rappel.dateRelanceObj) : '';
                    
                    let typeTag = '';
                    if (rappel.type === 'recu') {
                        typeTag = '<span class="tag tag-received">Reçu</span>';
                    } else if (rappel.type === 'passe') {
                        typeTag = '<span class="tag tag-outgoing">Passé</span>';
                    } else if (rappel.type === 'autre') {
                        typeTag = `<span class="tag tag-other">${rappel.autreType || 'Autre'}</span>`;
                    }

                    // Ajouter un indicateur de source pour les événements de l'agenda
                    const sourceIndicator = rappel.source === 'agenda' ? 
                        '<span class="tag" style="background-color: #9b59b6;">Agenda</span> ' : '';
                    
                    const timeDiv = document.createElement('div');
                    timeDiv.className = 'list-item-time';
                    timeDiv.textContent = heureStr;
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'list-item-content';
                    contentDiv.innerHTML = `
                        <div style="font-weight: bold;">${rappel.titre || rappel.nom}</div>
                        <div>${sourceIndicator}${typeTag} ${rappel.telephone || ''}</div>
                        <div style="margin-top: 5px; color: #666;">${rappel.commentaire}</div>
                    `;
                    
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'list-item-actions';
                    
                    // Adapter les actions selon la source
                    if (rappel.source === 'appels') {
                        const btnComplete = document.createElement('button');
                        btnComplete.className = 'btn-complete';
                        btnComplete.textContent = 'Terminé';
                        btnComplete.addEventListener('click', () => {
                            marquerCommeTermine(rappel.id);
                        });
                        actionsDiv.appendChild(btnComplete);
                    } else {
                        // Pour les éléments de l'agenda
                        const btnComplete = document.createElement('button');
                        btnComplete.className = 'btn-complete';
                        btnComplete.textContent = 'Terminé';
                        btnComplete.addEventListener('click', () => {
                            marquerAgendaCommeTermine(rappel.id);
                        });
                        actionsDiv.appendChild(btnComplete);
                    }
                    
                    const btnReschedule = document.createElement('button');
                    btnReschedule.className = 'btn-reschedule';
                    btnReschedule.textContent = 'Reprogrammer';
                    btnReschedule.addEventListener('click', () => {
                        ouvrirModalReprogrammation(rappel.id);
                    });
                    
                    const btnDetails = document.createElement('button');
                    btnDetails.className = 'btn-details';
                    btnDetails.textContent = 'Détails';
                    btnDetails.addEventListener('click', () => {
                        afficherDetailsRappel(rappel.id);
                    });
                    
                    actionsDiv.appendChild(btnReschedule);
                    actionsDiv.appendChild(btnDetails);
                    
                    item.appendChild(timeDiv);
                    item.appendChild(contentDiv);
                    item.appendChild(actionsDiv);
                    
                    group.appendChild(item);
                });
                
                container.appendChild(group);
            });
        }
        
        // ----- Fonctions de manipulation des rappels -----
        function afficherDetailsRappel(id) {
            const rappel = rappels.find(r => r.id === id);
            if (!rappel) return;
            
            selectedRappelId = id;
            
            let typeAffiche = '';
            if (rappel.type === 'recu') {
                typeAffiche = 'Appel reçu';
            } else if (rappel.type === 'passe') {
                typeAffiche = 'Appel passé';
            } else if (rappel.type === 'autre') {
                typeAffiche = `Autre (${rappel.autreType || ''})`;
            }
            
            let dateRappelAffichage = 'Non définie';
            if (rappel.dateRelanceObj) {
                dateRappelAffichage = `${formatDate(rappel.dateRelanceObj)} à ${formatTime(rappel.dateRelanceObj)}`;
                
                if (isOverdue(rappel.dateRelanceObj)) {
                    dateRappelAffichage += ' <span style="color: #e74c3c; font-weight: bold;">(Dépassée)</span>';
                }
            }
            
            let actionsEffectuees = '';
            if (rappel.actionsEchec && rappel.actionsEchec.length > 0) {
                const actions = {
                    'message': 'Message vocal',
                    'mail': 'E-mail',
                    'sms': 'SMS',
                    'rien': 'Aucune action'
                };
                
                actionsEffectuees = '<p><strong>Actions effectuées:</strong> ';
                actionsEffectuees += rappel.actionsEchec.map(action => 
                    `<span class="tag" style="background-color: #95a5a6;">${actions[action] || action}</span>`
                ).join(' ');
                actionsEffectuees += '</p>';
            }
            
            // Afficher la source
            const sourceInfo = `<p><strong>Source:</strong> ${rappel.source === 'agenda' ? 'Agenda' : 'Journal des appels'}</p>`;
            
            document.getElementById('detailContent').innerHTML = `
                ${sourceInfo}
                ${rappel.titre ? `<p><strong>Titre:</strong> ${rappel.titre}</p>` : ''}
                <p><strong>Date de création:</strong> ${rappel.date || new Date(rappel.creeLe || Date.now()).toLocaleDateString()}</p>
                <p><strong>Type:</strong> ${typeAffiche}</p>
                <p><strong>Contact:</strong> ${rappel.nom}</p>
                ${rappel.telephone ? `<p><strong>Téléphone:</strong> ${rappel.telephone}</p>` : ''}
                <p><strong>Date de rappel:</strong> ${dateRappelAffichage}</p>
                ${actionsEffectuees}
                <p><strong>Commentaire:</strong></p>
                <div style="background-color: #f2f2f2; padding: 10px; border-radius: 4px;">
                    ${(rappel.commentaire || "").replace(/\n/g, '<br>')}
                </div>
            `;
            
            // Adapter les actions selon la source
            if (rappel.source === 'appels') {
                document.getElementById('markCompleteBtn').onclick = () => {
                    marquerCommeTermine(selectedRappelId);
                    fermerModal('detailModal');
                };
            } else {
                document.getElementById('markCompleteBtn').onclick = () => {
                    marquerAgendaCommeTermine(selectedRappelId);
                    fermerModal('detailModal');
                };
            }
            
            // Amélioration du gestionnaire d'événements pour le bouton Reprogrammer
            document.getElementById('rescheduleBtn').onclick = () => {
                const idRappel = selectedRappelId; // Capturer l'ID explicitement pour éviter les changements de contexte
                console.log("Reprogrammation demandée pour:", idRappel);
                fermerModal('detailModal');
                setTimeout(() => {
                    // Utiliser setTimeout pour s'assurer que le modal est bien fermé avant d'en ouvrir un autre
                    ouvrirModalReprogrammation(idRappel);
                }, 100);
            };
            
            document.getElementById('detailModal').style.display = 'flex';
        }

        async function marquerCommeTermine(id) {
            try {
                await updateDoc(doc(db, "appels", id), {
                    enAttente: false,
                    dateFin: new Date().toISOString(),
                    commentaire: rappels.find(r => r.id === id).commentaire + 
                        `\n\n[${new Date().toLocaleString()}] Marqué comme terminé depuis l'agenda de rappel`
                });
                
                // Mettre à jour les compteurs manuellement pour une réponse plus rapide
                const index = rappels.findIndex(r => r.id === id);
                if (index !== -1) {
                    rappels.splice(index, 1);
                    miseAJourAffichage(); // Inclut miseAJourCompteurs()
                }
                
                afficherNotification("Rappel marqué comme terminé", "success");
            } catch (error) {
                console.error("Erreur lors du marquage:", error);
                afficherNotification("Erreur lors du marquage", "error");
            }
        }

        async function marquerAgendaCommeTermine(id) {
            try {
                // Récupérer le rappel avec l'ID correspondant
                const rappel = rappels.find(r => r.id === id);
                if (!rappel) {
                    throw new Error("Rappel non trouvé");
                }
                
                // Afficher une notification pour indiquer que le processus a démarré
                afficherNotification("Traitement en cours...", "info");
                
                // Mettre à jour le document dans la collection "agenda"
                await updateDoc(doc(db, "agenda", id), {
                    statut: "termine",
                    dateFin: new Date().toISOString(),
                    description: rappel.commentaire || "",  // Utiliser la valeur existante
                    termine: true
                });
                
                // Si l'élément de l'agenda est lié à un appel, mettre également à jour l'appel
                if (rappel.appelId) {
                    try {
                        // Vérifier si l'appelId est valide avant de tenter la mise à jour
                        if (rappel.appelId.trim() !== "") {
                            const appelRef = doc(db, "appels", rappel.appelId);
                            const appelDoc = await getDoc(appelRef);
                            
                            if (appelDoc.exists()) {
                                await updateDoc(appelRef, {
                                    enAttente: false,
                                    dateFin: new Date().toISOString()
                                });
                                console.log("Appel associé mis à jour avec succès:", rappel.appelId);
                            } else {
                                console.log("L'appel associé n'existe pas:", rappel.appelId);
                            }
                        }
                    } catch (error) {
                        console.error("Erreur lors de la mise à jour de l'appel associé:", error);
                        // On continue malgré l'erreur sur l'appel associé
                    }
                }
                
                // Suppression manuelle de l'élément pour un effet visuel immédiat
                const index = rappels.findIndex(r => r.id === id);
                if (index !== -1) {
                    rappels.splice(index, 1);
                }
                
                // Mettre à jour l'affichage et les compteurs
                miseAJourAffichage(); // Inclut miseAJourCompteurs()
                
                // Notification de succès
                afficherNotification("Rappel marqué comme terminé", "success");
            } catch (error) {
                console.error("Erreur lors du marquage:", error);
                afficherNotification("Erreur lors du marquage: " + error.message, "error");
            }
        }
        
        function ouvrirModalReprogrammation(id) {
            console.log("Ouverture du modal de reprogrammation pour l'ID:", id);
            
            const rappel = rappels.find(r => r.id === id);
            if (!rappel) {
                console.error("Rappel non trouvé:", id);
                afficherNotification("Erreur: Rappel non trouvé", "error");
                return;
            }
            
            selectedRappelId = id;
            console.log("Rappel sélectionné:", rappel);
            
            const newDateTimeInput = document.getElementById('newDateTime');
            
            if (rappel.dateRelanceObj && !isNaN(rappel.dateRelanceObj.getTime())) {
                // Formater la date au format attendu par l'input datetime-local
                const localDateString = rappel.dateRelanceObj.toISOString().slice(0, 16);
                console.log("Date actuelle formattée:", localDateString);
                newDateTimeInput.value = localDateString;
                miniCalendarDate = new Date(rappel.dateRelanceObj); // Utiliser la date du rappel
            } else {
                // Date par défaut: demain à 9h
                const demain = new Date();
                demain.setDate(demain.getDate() + 1);
                demain.setHours(9, 0, 0, 0);
                const demainStr = demain.toISOString().slice(0, 16);
                console.log("Date par défaut:", demainStr);
                newDateTimeInput.value = demainStr;
                miniCalendarDate = new Date(demain); // Utiliser la date par défaut
            }
            
            // Initialiser le mini-calendrier
            afficherMiniCalendrier();
            
            // Configuration des événements du mini-calendrier
            document.getElementById('prevMonthBtn').onclick = () => {
                miniCalendarDate.setMonth(miniCalendarDate.getMonth() - 1);
                afficherMiniCalendrier();
            };
            
            document.getElementById('nextMonthBtn').onclick = () => {
                miniCalendarDate.setMonth(miniCalendarDate.getMonth() + 1);
                afficherMiniCalendrier();
            };
            
            // S'assurer que le gestionnaire d'événements est correctement défini
            const saveButton = document.getElementById('saveRescheduleBtn');
            saveButton.onclick = null; // Supprimer les anciens gestionnaires
            saveButton.onclick = sauvegarderReprogrammation;
            
            // Ajouter un écouteur pour synchroniser l'input avec le calendrier
            newDateTimeInput.addEventListener('change', synchroniserCalendrierAvecInput);
            
            // Afficher le modal
            document.getElementById('rescheduleModal').style.display = 'flex';
        }
        
        // Fonction pour afficher le mini-calendrier
        function afficherMiniCalendrier() {
            const year = miniCalendarDate.getFullYear();
            const month = miniCalendarDate.getMonth();
            
            // Mettre à jour le titre du calendrier
            document.getElementById('miniCalendarTitle').textContent = 
                miniCalendarDate.toLocaleString('fr-FR', { month: 'long', year: 'numeric' });
            
            const firstDay = getFirstDayOfMonth(year, month);
            const firstDayOfWeek = getDayOfWeek(firstDay);
            const daysInMonth = getDaysInMonth(year, month);
            const daysInPrevMonth = getDaysInMonth(year, month - 1);
            
            const calendarDays = document.getElementById('miniCalendarDays');
            calendarDays.innerHTML = '';
            
            // Jours du mois précédent
            for (let i = 0; i < firstDayOfWeek; i++) {
                const day = daysInPrevMonth - firstDayOfWeek + i + 1;
                const date = new Date(year, month - 1, day);
                
                const dayEl = document.createElement('div');
                dayEl.className = 'mini-calendar-day other-month';
                dayEl.textContent = day;
                dayEl.dataset.date = date.toISOString().split('T')[0];
                dayEl.onclick = () => selectionnerJour(date);
                
                calendarDays.appendChild(dayEl);
            }
            
            // Jours du mois actuel
            const currentDateObj = new Date(); // Pour comparer avec aujourd'hui
            const selectedDate = new Date(document.getElementById('newDateTime').value);
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                
                const dayEl = document.createElement('div');
                dayEl.className = 'mini-calendar-day';
                
                // Marquer aujourd'hui
                if (date.getDate() === currentDateObj.getDate() && 
                    date.getMonth() === currentDateObj.getMonth() && 
                    date.getFullYear() === currentDateObj.getFullYear()) {
                    dayEl.classList.add('today');
                }
                
                // Marquer le jour sélectionné
                if (selectedDate && 
                    date.getDate() === selectedDate.getDate() && 
                    date.getMonth() === selectedDate.getMonth() && 
                    date.getFullYear() === selectedDate.getFullYear()) {
                    dayEl.classList.add('selected');
                }
                
                dayEl.textContent = day;
                dayEl.dataset.date = date.toISOString().split('T')[0];
                dayEl.onclick = () => selectionnerJour(date);
                
                calendarDays.appendChild(dayEl);
            }
            
            // Jours du mois suivant
            const cellsAdded = firstDayOfWeek + daysInMonth;
            const remainingCells = 42 - cellsAdded; // 6 semaines x 7 jours = 42
            
            for (let day = 1; day <= remainingCells; day++) {
                const date = new Date(year, month + 1, day);
                
                const dayEl = document.createElement('div');
                dayEl.className = 'mini-calendar-day other-month';
                dayEl.textContent = day;
                dayEl.dataset.date = date.toISOString().split('T')[0];
                dayEl.onclick = () => selectionnerJour(date);
                
                calendarDays.appendChild(dayEl);
            }
        }
        
        // Fonction pour sélectionner un jour dans le mini-calendrier
        function selectionnerJour(date) {
            // Mettre à jour l'input datetime-local
            const inputDateTime = document.getElementById('newDateTime');
            const currentDateTime = new Date(inputDateTime.value);
            
            // Conserver l'heure actuelle mais changer la date
            date.setHours(
                currentDateTime.getHours(),
                currentDateTime.getMinutes(),
                0, 0
            );
            
            // Mettre à jour l'input
            inputDateTime.value = date.toISOString().slice(0, 16);
            
            // Mettre à jour le mini-calendrier
            afficherMiniCalendrier();
        }
        
        // Fonction pour synchroniser le calendrier avec l'input datetime-local
        function synchroniserCalendrierAvecInput() {
            const inputValue = document.getElementById('newDateTime').value;
            if (inputValue) {
                miniCalendarDate = new Date(inputValue);
                afficherMiniCalendrier();
            }
        }
        
        function ajusterDate(jours, preset = null) {
            console.log("Ajustement de date:", jours, preset);
            
            const input = document.getElementById('newDateTime');
            let date;
            
            try {
                // Essayer de créer une date à partir de la valeur actuelle
                date = new Date(input.value);
                if (isNaN(date.getTime())) {
                    // Si la date n'est pas valide, utiliser la date actuelle
                    console.warn("Date invalide dans l'input, utilisation de la date actuelle");
                    date = new Date();
                }
            } catch (e) {
                console.error("Erreur lors du parsing de la date:", e);
                date = new Date();
            }
            
            if (preset === 'today') {
                date = new Date();
                date.setHours(date.getHours() + 1, 0, 0, 0);
                console.log("Date ajustée à aujourd'hui:", date);
            } else if (preset === 'tomorrow') {
                date = new Date();
                date.setDate(date.getDate() + 1);
                date.setHours(9, 0, 0, 0);
                console.log("Date ajustée à demain:", date);
            } else if (preset === 'nextWorkDay') {
                date = getNextWorkDay();
                date.setHours(9, 0, 0, 0);
                console.log("Date ajustée au prochain jour ouvré:", date);
            } else {
                date.setDate(date.getDate() + jours);
                console.log("Date ajustée de", jours, "jours:", date);
            }
            
            // Formater la date pour l'input datetime-local (YYYY-MM-DDTHH:MM)
            const formattedDate = date.toISOString().slice(0, 16);
            console.log("Date formatée pour l'input:", formattedDate);
            input.value = formattedDate;
            
            // Synchroniser le mini-calendrier
            miniCalendarDate = new Date(date);
            afficherMiniCalendrier();
        }

        async function sauvegarderReprogrammation() {
            if (!selectedRappelId) {
                console.log("Erreur: Aucun ID de rappel sélectionné");
                fermerModal('rescheduleModal');
                return;
            }
            
            try {
                // Afficher une notification pour indiquer que le traitement commence
                afficherNotification("Reprogrammation en cours...", "info");
                
                const rappel = rappels.find(r => r.id === selectedRappelId);
                if (!rappel) {
                    throw new Error("Rappel non trouvé avec l'ID: " + selectedRappelId);
                }
                
                console.log("Reprogrammation du rappel:", rappel);
                
                // Récupérer et formater correctement la nouvelle date
                const inputValue = document.getElementById('newDateTime').value;
                if (!inputValue) {
                    throw new Error("Veuillez spécifier une date valide");
                }
                
                // Créer un objet Date à partir de la valeur d'entrée
                const dateObj = new Date(inputValue);
                if (isNaN(dateObj.getTime())) {
                    throw new Error("Format de date invalide");
                }
                
                // Formater la date en ISO string pour Firebase
                const nouvelleDate = dateObj.toISOString();
                console.log("Nouvelle date (ISO):", nouvelleDate);
                
                if (rappel.source === 'appels') {
                    // Pour les appels
                    console.log("Mise à jour d'un rappel d'appel:", selectedRappelId);
                    await updateDoc(doc(db, "appels", selectedRappelId), {
                        dateRelance: nouvelleDate,
                        commentaire: (rappel.commentaire || "") + 
                            `\n\n[${new Date().toLocaleString()}] Rappel reprogrammé pour le ${dateObj.toLocaleString()}`
                    });
                } else {
                    // Pour les éléments de l'agenda
                    console.log("Mise à jour d'un élément d'agenda:", selectedRappelId);
                    
                    // Créer un objet avec les champs à mettre à jour
                    const updateFields = {
                        dateDebut: nouvelleDate,
                        dateFin: nouvelleDate, // Mise à jour de la date de fin également
                        description: (rappel.commentaire || "") + 
                            `\n\n[${new Date().toLocaleString()}] Rappel reprogrammé pour le ${dateObj.toLocaleString()}`
                    };
                    
                    // Si l'élément a un champ dateFin, le mettre à jour également
                    await updateDoc(doc(db, "agenda", selectedRappelId), updateFields);
                    console.log("Élément d'agenda mis à jour avec succès:", updateFields);
                }
                
                // Mise à jour locale pour effet immédiat
                console.log("Mise à jour locale du rappel");
                rappel.dateRelanceObj = new Date(nouvelleDate);
                if (rappel.source === 'agenda') {
                    rappel.commentaire = (rappel.commentaire || "") + 
                        `\n\n[${new Date().toLocaleString()}] Rappel reprogrammé pour le ${dateObj.toLocaleString()}`;
                }
                
                // Fermer le modal
                fermerModal('rescheduleModal');
                
                // Mise à jour de l'affichage
                miseAJourAffichage();
                
                // Notification de succès
                afficherNotification("Rappel reprogrammé avec succès", "success");
            } catch (error) {
                console.error("Erreur lors de la reprogrammation:", error);
                afficherNotification("Erreur: " + error.message, "error");
            }
        }

        function rechercherRappels() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (!searchTerm) {
                miseAJourAffichage();
                return;
            }
            
            const rappelsFiltres = rappels.filter(rappel => {
                return (
                    (rappel.nom && rappel.nom.toLowerCase().includes(searchTerm)) ||
                    (rappel.telephone && rappel.telephone.toLowerCase().includes(searchTerm)) ||
                    (rappel.commentaire && rappel.commentaire.toLowerCase().includes(searchTerm))
                );
            });
            
            afficherResultatsRecherche(rappelsFiltres);
        }
        
        function afficherResultatsRecherche(rappelsFiltres) {
            changerVue('list');
            
            const container = document.getElementById('listContainer');
            container.innerHTML = '';
            
            if (rappelsFiltres.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'loading';
                emptyMessage.textContent = 'Aucun résultat trouvé';
                container.appendChild(emptyMessage);
                return;
            }
            
            const group = document.createElement('div');
            group.className = 'list-group';
            
            const header = document.createElement('div');
            header.className = 'list-header';
            header.innerHTML = `Résultats de recherche (${rappelsFiltres.length})`;
            
            group.appendChild(header);
            
            rappelsFiltres.forEach(rappel => {
                const item = document.createElement('div');
                item.className = 'list-item';
                
                const heureStr = rappel.dateRelanceObj ? 
                    formatTime(rappel.dateRelanceObj) : '';
                
                const dateStr = rappel.dateRelanceObj ? 
                    rappel.dateRelanceObj.toLocaleDateString('fr-FR') : 'Sans date';
                
                let typeTag = '';
                if (rappel.type === 'recu') {
                    typeTag = '<span class="tag tag-received">Reçu</span>';
                } else if (rappel.type === 'passe') {
                    typeTag = '<span class="tag tag-outgoing">Passé</span>';
                } else if (rappel.type === 'autre') {
                    typeTag = `<span class="tag tag-other">${rappel.autreType || 'Autre'}</span>`;
                }
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'list-item-time';
                timeDiv.innerHTML = `${heureStr}<br><small>${dateStr}</small>`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'list-item-content';
                contentDiv.innerHTML = `
                    <div style="font-weight: bold;">${rappel.nom}</div>
                    <div>${typeTag} ${rappel.telephone || ''}</div>
                    <div style="margin-top: 5px; color: #666;">${rappel.commentaire}</div>
                `;
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'list-item-actions';
                
                const btnComplete = document.createElement('button');
                btnComplete.className = 'btn-complete';
                btnComplete.textContent = 'Terminé';
                
                // Corriger le gestionnaire d'événements en fonction de la source
                if (rappel.source === 'appels') {
                    btnComplete.addEventListener('click', () => {
                        marquerCommeTermine(rappel.id);
                    });
                } else {
                    btnComplete.addEventListener('click', () => {
                        marquerAgendaCommeTermine(rappel.id);
                    });
                }
                
                const btnReschedule = document.createElement('button');
                btnReschedule.className = 'btn-reschedule';
                btnReschedule.textContent = 'Reprogrammer';
                btnReschedule.addEventListener('click', () => {
                    ouvrirModalReprogrammation(rappel.id);
                });
                
                const btnDetails = document.createElement('button');
                btnDetails.className = 'btn-details';
                btnDetails.textContent = 'Détails';
                btnDetails.addEventListener('click', () => {
                    afficherDetailsRappel(rappel.id);
                });
                
                actionsDiv.appendChild(btnComplete);
                actionsDiv.appendChild(btnReschedule);
                actionsDiv.appendChild(btnDetails);
                
                item.appendChild(timeDiv);
                item.appendChild(contentDiv);
                item.appendChild(actionsDiv);
                
                group.appendChild(item);
            });
            
            container.appendChild(group);
        }
        
        function fermerModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            
            // Ne pas réinitialiser selectedRappelId immédiatement si on passe au modal de reprogrammation
            if (modalId === 'detailModal' && !document.getElementById('rescheduleModal').style.display === 'flex') {
                selectedRappelId = null;
            }
            
            if (modalId === 'rescheduleModal') {
                // Attendre un court instant avant de réinitialiser selectedRappelId
                // pour s'assurer que toute action associée soit terminée
                setTimeout(() => {
                    selectedRappelId = null;
                }, 500);
            }
        }
        
        function afficherNotification(message, type = "info") {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = "notification " + type;
            notification.style.display = "block";
            
            setTimeout(() => {
                notification.style.display = "none";
            }, 3000);
        }
        
        // ----- Navigation et gestion des vues -----
        function changerVue(vue) {
            console.log(`Changing view from ${currentView} to ${vue}`);
            currentView = vue;
            
            document.getElementById('monthView').style.display = 'none';
            document.getElementById('listView').style.display = 'none';
            
            document.getElementById(`${vue}View`).style.display = 'block';
            
            document.querySelectorAll('.view-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`${vue}ViewBtn`).classList.add('active');
            
            miseAJourAffichage();
            console.log(`View changed to ${vue}`);
        }
        
        function navPrecedent() {
            switch (currentView) {
                case 'month': currentDate.setMonth(currentDate.getMonth() - 1); break;
                case 'list': return;
            }
            
            miseAJourAffichage();
        }
        
        function navSuivant() {
            switch (currentView) {
                case 'month': currentDate.setMonth(currentDate.getMonth() + 1); break;
                case 'list': return;
            }
            
            miseAJourAffichage();
        }
        
        function navAujourdhui() {
            currentDate = new Date();
            miseAJourAffichage();
        }
        
        // ----- Initialisation -----
        function initialiserApp() {
            chargerRappels();
            
            document.getElementById('todayBtn').addEventListener('click', navAujourdhui);
            document.getElementById('prevBtn').addEventListener('click', navPrecedent);
            document.getElementById('nextBtn').addEventListener('click', navSuivant);
            
            document.getElementById('monthViewBtn').addEventListener('click', () => changerVue('month'));
            document.getElementById('listViewBtn').addEventListener('click', () => changerVue('list'));
            
            document.getElementById('searchInput').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    rechercherRappels();
                }
            });
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                    selectedRappelId = null;
                }
            });
            
            // Programmer une mise à jour régulière des compteurs (toutes les 5 minutes)
            setInterval(miseAJourCompteurs, 300000);
            
            miseAJourAffichage(); // Inclut miseAJourCompteurs()
        }
        
        // Exposer les fonctions au scope global
        window.fermerModal = fermerModal;
        window.marquerCommeTermine = marquerCommeTermine;
        window.afficherDetailsRappel = afficherDetailsRappel;
        window.ouvrirModalReprogrammation = ouvrirModalReprogrammation;
        window.ajusterDate = ajusterDate;
        window.sauvegarderReprogrammation = sauvegarderReprogrammation;
        window.marquerAgendaCommeTermine = marquerAgendaCommeTermine;
        
        // Initialiser l'application au chargement de la page
        document.addEventListener('DOMContentLoaded', initialiserApp);
    </script>
</body>
</html>
